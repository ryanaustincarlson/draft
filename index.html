<html>

<head>
<!-- wysihtml5 parser rules -->
<!-- <script src="wysihtml5/parser_rules/advanced.js"></script> -->
<!-- Library -->
<!-- <script src="wysihtml5/dist/wysihtml5-0.3.0.min.js"></script> -->

<!-- css -->
<link rel="stylesheet" type="text/css" href="style.css" />

<title>
Draft
</title>

<!-- <link rel="stylesheet" href="../wysihtml5/website/css/stylesheet.css" -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui.min.js" type="text/javascript"></script>

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" />
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js" type="text/javascript"></script>

<link rel="stylesheet" href="./lib/ui.fancytree.css" type="text/css" class="skinswitcher">

<script src="./lib/jquery.fancytree.js" type="text/javascript"></script>
<script src="./lib/jquery.fancytree.edit.js" type="text/javascript"></script>
<script src="./lib/jquery.fancytree.glyph.js" type="text/javascript"></script>
<script src="./lib/jquery.fancytree.dnd.js" type="text/javascript"></script>

<script src="./lib/rangy-core.js" type="text/javascript"></script>
<script src="./lib/rangy-textrange.js" type="text/javascript"></script>
<script src="./lib/rangy-classapplier.js" type="text/javascript"></script>

<!-- Add code to initialize the tree when the document is loaded: -->
<script src="fancytree.js" type="text/javascript"> </script>

<style type="text/css">
		*.darkSeaGreen {
			background-color: darkSeaGreen;
		}
		*.cornflowerBlue {
			background-color: cornflowerBlue;
		}
		*.chartreuse {
			background-color: chartreuse;
		}
		*.red {
			background-color: red;
		}
		*.orange {
			background-color: orange;
		}
		*.lightSlateBlue {
			background-color: lightSlateBlue;
		}
	</style>

</head>



<body>
<!-- load jquery -->
<!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" ></script> -->
<!-- <div class="toolbar" id="wysihtml5-outline-toolbar" > -->
<!-- </div> -->

<div class="editor" id="outline-editor" >
	<br>
	<h2>Outline</h2>
	<!-- <textarea id="draft-outline" ></textarea> -->
	<p>
		<button id="btnExpandAll" class="btn btn-sm btn-primary" onclick="expandAll()">Expand all</button>
		<button id="btnCollapseAll" class="btn btn-sm btn-warning" onclick="collapseAll()">Collapse all</button>
		<button id="btnAddNode" class="btn btn-sm btn-primary" onclick="addNode()">Add Node</button>
		<button id="btnLeft" class="btn btn-sm btn-primary" onclick="moveLeft()">&#8592;</button>
		<button id="btnRight" class="btn btn-sm btn-primary" onclick="moveRight()">&#8594;</button>
	</p>
	<div id="tree"> </div>
</div>

<div class="editor" id="editor" >
	<input id="analyze-button" type="button" value="Analyze" onclick="analyze()" >
	<input id="clear-button" type="button" value="Clear Highlights" onclick="clearHighlights()" >
	
	<input id="manual-highlight" type="button" value="Manual Highlight" onclick="manualHighlight()" disabled >
	<input id="fillin-button" type="button" value="Fill In" onclick="fillin()" >
	<br>
	<h2>Essay</h2>
	<!-- <textarea id="draft-text" ></textarea> -->
</div>

<script type="text/javascript" src="editor.js"></script>
<script type="text/javascript" src="analyze.js"></script>

<script type="text/javascript">
	// var editor = new WysihtmlEditor("wysihtml5-textarea", "editor");
	// var outline = new WysihtmlOutlineEditor("wysihtml5-outline", "outline-editor");

	var editor = new DraftEditor("draft-text", "editor");
	// var outline = new DraftOutlineEditor("draft-outline", "outline-editor");
	var outline = new DraftTreeOutlineEditor("draft-outline", "outline-editor");

	editor.initialize();
	outline.initialize();

	var analyzer = new Analyzer(editor, outline);
	var selectedNode = null;

	$(window).load(function() {
		$("#tree").fancytree("option", "select", function(event, data)
		{
			if (data.node.isSelected())
			{
				selectedNode = data.node;

				var manualHighlightButton = document.getElementById("manual-highlight");
				manualHighlightButton.disabled = false;
			}
		});
	});

	function analyze()
	{
		analyzer.analyze()
	}

	function clearHighlights()
	{
		analyzer.clearHighlights();
	}

	function manualHighlight()
	{
		var editorNode = document.getElementById(editor.id);
		var editorText = editorNode.innerText;

		// var range = rangy.createRange(editorNode);
		var selection = rangy.getSelection();
		console.log("selected: " + selection);
		if (selection.rangeCount == 1 && !!selectedNode)
		{
			var selectionRange = selection.getRangeAt(0);

			var containerText = selectionRange.startContainer.data;
			var containerOffset = editorText.indexOf(containerText);

			if (containerOffset >= 0)
			{
				var sentence = new DraftEditorSentence(
					editor, 
					selection.text(), 
					selectionRange.startOffset+containerOffset,
					selectionRange.endOffset+containerOffset);
				var bullet = new DraftOutlineBulletPoint(selectedNode);

				analyzer.highlighter.highlight(sentence, bullet);

				analyzer.addMatch(sentence, bullet);
			}
		}
		else
		{
			// un-select a node
		}

		var manualHighlightButton = document.getElementById("manual-highlight");
		manualHighlightButton.disabled = true;
	}

	// console.log("editor: " + editor.html())
	// console.log("outline: " + outline.html())
</script>

<script type="text/javascript">
	// seed with some existing stuff
	function fillin()
	{
		$("#tree").fancytree("option", "source", [
			{title: "This is the first point of the essay.", key: "1"},
      		{title: "Here's the second point, which is also really important!", key: "2"}, //expanded:true, children: [
      		{title: "And look, a third point!", key: "3"},
      		{title: "The fourth point is the very best.", key: "4"}, //expanded:true, children: [
      		{title: "Here is some totally random text.", key: "5"},
      	]);

		var essay = document.getElementById("draft-text");
		essay.innerHTML = "I present the first point of the essay. My second point is really important, too. This be completely unrelated. The fourth is the best point. But look, found my third point!"
	}
</script>

<!-- <br><br><br><br> -->
<!-- <h2>Log</h2> -->
<!-- <div id="log" /> -->

<!-- <script type="text/javascript" src="analyze.js"></script>	 -->

</body>
</html>
